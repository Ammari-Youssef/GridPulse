<div class="w-full">
  <div class="bg-white rounded-lg shadow-lg overflow-hidden">
    <!-- Header -->
    <div class="p-6 border-b border-gray-200">
      <h2 class="text-2xl font-bold text-gray-800">System Alerts & Messages</h2>
      <p class="text-sm text-gray-600 mt-1">Monitor device communications and system alerts</p>
    </div>

    <!-- Error Message -->
    <div *ngIf="error" class="p-4 bg-red-50 border-l-4 border-red-500">
      <p class="text-red-700">{{ error }}</p>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="p-8 flex items-center justify-center">
      <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
        <p class="mt-4 text-gray-600">Loading messages...</p>
      </div>
    </div>

    <!-- Messages Table (desktop/tablet) -->
    <div *ngIf="!loading" class="hidden sm:block overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50 border-b border-gray-200">
          <tr>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
              (click)="sort('severity')">
              <div class="flex items-center gap-2">
                Severity
                <span *ngIf="sortBy === 'severity'">{{ sortDesc ? '↓' : '↑' }}</span>
              </div>
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
              (click)="sort('messageType')">
              <div class="flex items-center gap-2">
                Type
                <span *ngIf="sortBy === 'messageType'">{{ sortDesc ? '↓' : '↑' }}</span>
              </div>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Device</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Explanation</th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
              (click)="sort('receivedAt')">
              <div class="flex items-center gap-2">
                Received
                <span *ngIf="sortBy === 'receivedAt'">{{ sortDesc ? '↓' : '↑' }}</span>
              </div>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr *ngFor="let message of messages" class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap">
              <span [class]="getSeverityColor(message.severity)" class="px-2 py-1 text-xs font-semibold rounded-full">
                {{ message.severity }}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span [class]="getTypeColor(message.messageType)" class="px-2 py-1 text-xs font-semibold rounded-full">
                {{ message.messageType }}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">{{ message.device.name }}</div>
              <div class="text-xs text-gray-500">{{ message.device.fleet.name || 'No Fleet' }}</div>
            </td>
            <td class="px-6 py-4">
              <div class="text-sm text-gray-600 max-w-md truncate">{{ message.explanation }}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-600">{{ formatDateTime(message.receivedAt) }}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
              <button (click)="viewMessage(message)" class="text-blue-600 hover:text-blue-800 font-medium">View
                Details</button>
            </td>
          </tr>
          <tr *ngIf="messages.length === 0">
            <td colspan="6" class="px-6 py-8 text-center text-gray-500">No messages found</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Messages Cards (mobile) -->
    <div *ngIf="!loading" class="sm:hidden space-y-4 p-4">
      <div *ngFor="let message of messages" class="p-4 bg-white rounded shadow">
        <div class="flex justify-between items-center">
          <span [class]="getSeverityColor(message.severity)" class="px-2 py-1 text-xs font-semibold rounded-full">
            {{ message.severity }}
          </span>
          <span [class]="getTypeColor(message.messageType)" class="px-2 py-1 text-xs font-semibold rounded-full">
            {{ message.messageType }}
          </span>
        </div>
        <div class="mt-2">
          <div class="font-semibold text-gray-900">{{ message.device.name }}</div>
          <div class="text-xs text-gray-500">{{ message.device.fleet.name || 'No Fleet' }}</div>
        </div>
        <div class="text-sm text-gray-600 mt-2">{{ message.explanation }}</div>
        <div class="text-xs text-gray-500 mt-1">{{ formatDateTime(message.receivedAt) }}</div>
        <div class="mt-3">
          <button (click)="viewMessage(message)" class="text-blue-600 hover:text-blue-800 font-medium">View
            Details</button>
        </div>
      </div>
      <div *ngIf="messages.length === 0" class="text-center text-gray-500">No messages found</div>
    </div>

    <!-- Pagination -->
    <div *ngIf="!loading && messages.length > 0" class="px-6 py-4 bg-gray-50 border-t border-gray-200">
      <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
        <div class="text-sm text-gray-700">
          Showing <span class="font-medium">{{ currentPage * pageSize + 1 }}</span>
          to <span class="font-medium">{{ endIndex }}</span>
          of <span class="font-medium">{{ totalElements }}</span> results
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-700">Rows per page:</label>
          <select [value]="pageSize" (change)="changePageSize(+$any($event.target).value)"
            class="border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-blue-500">
            <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
          </select>
        </div>
        <div class="flex flex-wrap items-center gap-2">
          <button (click)="previousPage()" [disabled]="currentPage === 0"
            class="px-3 py-1 border border-gray-300 rounded text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">
            Previous
          </button>
          <button *ngFor="let page of getPageNumbers()" (click)="goToPage(page)"
            [class.bg-blue-600]="page === currentPage" [class.text-white]="page === currentPage"
            class="px-3 py-1 border border-gray-300 rounded text-sm font-medium hover:bg-gray-50">
            {{ page + 1 }}
          </button>
          <button (click)="nextPage()" [disabled]="currentPage >= totalPages - 1"
            class="px-3 py-1 border border-gray-300 rounded text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">
            Next
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- View Message Modal -->
<div *ngIf="showViewModal" class="fixed inset-0 backdrop-blur-sm bg-white/30 flex items-center justify-center z-50"
  role="dialog" aria-modal="true" (click)="closeViewModal()">
  <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto"
    (click)="$event.stopPropagation()">
    <div class="p-6 border-b border-gray-200 flex justify-between items-center">
      <h3 class="text-xl font-bold text-gray-800">Message Details</h3>
      <button (click)="closeViewModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
        ✕
      </button>
    </div>

    <div *ngIf="selectedMessage" class="p-6 space-y-4">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="text-sm font-semibold text-gray-600">Severity</label>
          <p class="mt-1">
            <span [class]="getSeverityColor(selectedMessage.severity)"
              class="px-2 py-1 text-xs font-semibold rounded-full">
              {{ selectedMessage.severity }}
            </span>
          </p>
        </div>
        <div>
          <label class="text-sm font-semibold text-gray-600">Type</label>
          <p class="mt-1">
            <span [class]="getTypeColor(selectedMessage.messageType)"
              class="px-2 py-1 text-xs font-semibold rounded-full">
              {{ selectedMessage.messageType }}
            </span>
          </p>
        </div>
        <div>
          <label class="text-sm font-semibold text-gray-600">Device</label>
          <p class="text-gray-900 mt-1">{{ selectedMessage.device.name }}</p>
          <p class="text-xs text-gray-500">{{ selectedMessage.device.serialNumber }}</p>
        </div>
        <div>
          <label class="text-sm font-semibold text-gray-600">Fleet</label>
          <p class="text-gray-900 mt-1">{{ selectedMessage.device.fleet.name }}</p>
        </div>
        <div>
          <label class="text-sm font-semibold text-gray-600">Received At</label>
          <p class="text-gray-900 mt-1">{{ formatDateTime(selectedMessage.receivedAt) }}</p>
        </div>
        <div>
          <label class="text-sm font-semibold text-gray-600">Sent At</label>
          <p class="text-gray-900 mt-1">{{ formatDateTime(selectedMessage.sentAt) }}</p>
        </div>
        <div class="sm:col-span-2">
          <label class="text-sm font-semibold text-gray-600">Explanation</label>
          <p class="text-gray-900 mt-1">{{ selectedMessage.explanation }}</p>
        </div>
        <div class="sm:col-span-2">
          <label class="text-sm font-semibold text-gray-600">Message Payload</label>
          <pre class="mt-1 p-4 bg-gray-50 rounded text-xs overflow-auto max-h-64">
            {{ formatPayload(selectedMessage.messageText) }}
          </pre>
        </div>
        <div>
          <label class="text-sm font-semibold text-gray-600">Cloud Message ID</label>
          <p class="text-gray-600 text-xs mt-1 font-mono">{{ selectedMessage.cloudMessageId }}</p>
        </div>
        <div>
          <label class="text-sm font-semibold text-gray-600">Status</label>
          <p class="text-gray-900 mt-1">{{ selectedMessage.status }}</p>
        </div>
      </div>
    </div>

    <div class="p-6 border-t border-gray-200 flex justify-end">
      <button (click)="closeViewModal()"
        class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors">
        Close
      </button>
    </div>
  </div>
</div>